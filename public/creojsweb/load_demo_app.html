<html>
<head>
    <title>Test model parameters customization</title>

    <script src="creojs.js"></script>
    <script type="text/creojs" src="browser.creojs"></script>

    <script type="text/creojs">
        if (typeof pfcSession.Current === 'undefined')
        {
            function inheritFrom (to, from) {
                const to_proto = to.prototype
                const from_proto = from.prototype
                for (const prop in from_proto) if (!(prop in to_proto)) to_proto [prop] = from_proto [prop]
            }
            pfcParamValue.prototype.toString = function () {return String (this.Value)}
            pfcParamValue.prototype.toJSON = function () {return {$type: 'pfcParamValue', discr:this.discr.string(), value: this.Value}}
            pfcParamValue.fromJSON = function (json) {
                if (json.$type !== 'pfcParamValue') throw new Error ('exepected $type===pfcParamValue')
                const value = pfcParamValue.Empty
                const type = json.discr
                value.setValueOf (pfcParamValueType.values().find (v=>v.string()===type), json.value)
                return value
            }
        
            pfcParamValue.prototype.setValueOf = function (type, value)
            {
                if (!type) {
                    if (Number.isInteger (value)) type = pfcParamValueType.PARAM_INTEGER
                    else if (typeof value === 'number') type = pfcParamValueType.PARAM_DOUBLE
                    else if (typeof value === 'boolean') type = pfcParamValueType.PARAM_BOOLEAN
                    else type = pfcParamValueType.PARAM_STRING
                }
                switch (type) {
                    case pfcParamValueType.PARAM_STRING: this.StringValue = String (value); break;
                    case pfcParamValueType.PARAM_INTEGER: this.IntValue = value; break;
                    case pfcParamValueType.PARAM_BOOLEAN: this.BoolValue = Boolean (value); break;
                    case pfcParamValueType.PARAM_DOUBLE: this.DoubleValue = value; break;
                    case pfcParamValueType.PARAM_NOTE: this.NoteId = value; break;
                    default: throw 'wrong parameter type'; break;
                }
            }
        
            Object.defineProperty (pfcParamValue.prototype, 'Value', {
                configurable: true,
                enumerable: true,
                get: function () {
                    switch (this.discr) {
                        case pfcParamValueType.PARAM_STRING: return this.StringValue
                        case pfcParamValueType.PARAM_INTEGER: return this.IntValue
                        case pfcParamValueType.PARAM_BOOLEAN: return this.BoolValue
                        case pfcParamValueType.PARAM_DOUBLE: return this.DoubleValue
                        case pfcParamValueType.PARAM_NOTE: return this.NoteId
                        default: return undefined;
                    }
                },
                set: function (value) {
                    this.setValueOf (undefined, value)
                }
            })
        
            Object.defineProperty (pfcParamValue, 'Empty', {
                configurable: true,
                enumerable: true,
                get: function () {
                    // hack!: WebLink doesn't provide way to create a new parameter value
                    // use some existing value and store it in session for future reuse
                    let emptyValue = pfcSession.Storage ['${EMPTY_PARAM_VALUE}']
                    if (!emptyValue) {
                        function saveEmptyValue (param) {
                            const value = param.Value
                            pfcSession.Storage ['${EMPTY_PARAM_VALUE}'] = value
                            return value
                        }
                        const session = pfcSession.Current
                        for (const model of session.ListModels ()) {
                            for (const param of model.ListParams()) {
                                return saveEmptyValue (param)
                            }
                        }
                        const part = session.openModelFromDir (pfcSession.CreoJSRootDir, 'empty_with_params.prt')
                        if (part) {
                            const value = saveEmptyValue (part.ListParams()[0])
                            part.Erase()
                            return value
                        }
                        throw new Error ('cannot obtain empty value')
                    }
                    return emptyValue
                }
            })
        
            function createAppDataProxy (appName, prefs) {
                const asPath = prop => appName ? `${appName}/${prop}.json` : `${prop}.json`
                return new Proxy (new Object(), {
                    get (obj, prop) {try {return getFromAppData(`${asPath (prop)}`, prefs)} catch (ex) {return undefined}},
                    set (obj, prop, value) {saveToAppData (`${asPath (prop)}`, value, prefs)},
                    deleteProperty (obj, prop, descriptor) {deleteFromAppData (`${asPath (prop)}`, prefs)}
                })
            }
        
            pfcSession.AppData = createAppDataProxy ()
            pfcSession.Preferences = createAppDataProxy (undefined, true)
        
            pfcSession.Apps = new Proxy (new Object(), {
                get (obj, prop) {return new Proxy (new Object(), {
                    get (obj, type) {
                        switch (type)
                        {
                            case 'Data': return createAppDataProxy (prop)
                            case 'Prefs': return createAppDataProxy (prop, true)
                            default: return undefined
                        }
                    }})
                                                }})
        
            pfcSession.Storage = new Proxy (new Object(), {
                get (obj, prop) {return getFromSession (prop)},
                set (obj, prop, value) {saveToSession (prop, value)},
                deleteProperty (obj, prop, descriptor) {removeFromSession (prop)}
            })
        
            pfcSession.prototype.openModelFromSearchPath = function (filename) {
                return this.RetrieveModel (pfcModelDescriptor.CreateFromFileName (filename))
            }
        
            pfcSession.prototype.openModelFromDir = function (dir, filename) {
                const descr = pfcModelDescriptor.CreateFromFileName (filename)
                descr.Path = dir
                return this.RetrieveModelWithOpts (descr, null)
            }
        
            const COMMAND_REGISTRY = '${COMMAND_LISTENERS}'
            if (!pfcSession.Storage [COMMAND_REGISTRY]) pfcSession.Storage [COMMAND_REGISTRY] = {}
            
            pfcSession.prototype.createUICommand =
            function ({name, label, icon, action, access, messages = "creo_js_messages.txt"}) {
                let actionCB = pfcSession.Storage [COMMAND_REGISTRY] [name]
                let command = null
                if (actionCB) {
                    command = this.UIGetCommand	(name)
                }
                else {
                    command = this.UICreateCommand	(name, pfcUICommandActionListener.create ({OnCommand: function () {
                        const action = pfcSession.Storage [COMMAND_REGISTRY] [name]
                        if (action) action ()
                    }}))
                }
                pfcSession.Storage [COMMAND_REGISTRY] [name] = action
                if (label) command.Designate (messages, label)
                if (icon) command.SetIcon (icon)
                if (typeof access === 'function') {
                    CreoJS.addListener (command, pfcUICommandAccessListener.create (
                        {OnCommandAccess: arg => pfcCommandAccess.from(access (arg))}))
                }
                return command
            }
        
            pfcSession.prototype.runUICommand = function (command, ...args) {
                this.RunMacro ('~ Command `' + command + '`' + (args.length ? ` ${args.join(" ")}` : ''))
            }
            
            pfcSession.prototype.showDialog =
            function ({label, buttons = [pfcMessageButton.MESSAGE_BUTTON_OK], focus, type}) {
                const opts = pfcMessageDialogOptions.Create ();
                if (buttons) opts.SetButtons (buttons)
                if (focus) opts.SetDefaultButton (focus)
                if (type) opts.SetMessageDialogType (type)
                return pfcSession.Current.UIShowMessageDialog (label, opts)
            }
        
            if (typeof wfcWSession != 'undefined') inheritFrom (wfcWSession, pfcSession)
            
            pfcSession.Current = pfcGetCurrentSession ()
            pfcSession.CreoJSRootDir = `${pfcSession.Current.GetEnvironmentVariable ('PRO_DIRECTORY').replace(/\\/g, '/')}/apps/creojs/creojsweb`
        
            pfcCommandAccess.has = v => pfcCommandAccess.values().find (ev=>ev===v)
            pfcCommandAccess.from = v => pfcCommandAccess.has (v) ? v : v ? pfcCommandAccess.ACCESS_AVAILABLE : pfcCommandAccess.ACCESS_UNAVAILABLE
                
            /*
            * Script shows how to set a various listeners and create UI commands to customize Creo behavior. 
            */
            
            // require ('extend_pfc')
            
            function askQuestion (question) {
                return pfcSession.Current.showDialog (
                    {label: question, type: pfcMessageDialogType.MESSAGE_QUESTION, focus: pfcMessageButton.MESSAGE_BUTTON_NO,
                    buttons: [pfcMessageButton.MESSAGE_BUTTON_YES,pfcMessageButton.MESSAGE_BUTTON_NO]}
                ) === pfcMessageButton.MESSAGE_BUTTON_YES
            }
            
            function reportProblem (message) {
                pfcSession.Current.showDialog (
                    {label: message, type: pfcMessageDialogType.MESSAGE_WARNING,
                    buttons: [pfcMessageButton.MESSAGE_BUTTON_OK]})
            }
            
            function addParameter (model, name, type, value)
            {
                try {
                    const paramValue = pfcParamValue.Empty
                    if (paramValue) {
                        if (typeof value === 'function') value = value ()
                        paramValue.setValueOf (type, value)
                        //print (`<b>Creating parameter</b> ${paramValue.discr} ${name} = ${JSON.stringify (String (paramValue))}`)
                        model.CreateParam (name, paramValue)
                    }
                    else {
                        //print (`Don't have empty value to initialize a parameter`)
                    }
                }
                catch (ex) {
                    //print (`Exception: ${ex}`)
                }
            }
            
            function addParameters (owner, ...params) {
                try {
                    for (const parm of params) addParameter (owner, parm.name, parm.type, parm.value)
                }
                catch (ex) {/*print (ex)*/}
            }
            
            function currentTimestampParameters (currentUserParm, currentTimeParm) {
                return [{name: currentUserParm, value: ()=>pfcSession.Current.GetEnvironmentVariable ('USER')},
                                {name: currentTimeParm, value: ()=>new Date ().toISOString()}]
            }
            
            function testAddingParameterOnModelCreate (...args) {
                const prefs = pfcSession.Apps.demo.Prefs.defaults
                let anchorPartName = (prefs ? prefs.anchorPart : undefined) || 'anchor'
                const session = pfcSession.Current
                CreoJS.clearListeners () // For debugging...
                function updateNavigatorPane () {
                    const bomHTML = 'model_structure.html'
                    if (session.ListFiles (bomHTML, pfcFileListOpt.FILE_LIST_ALL, pfcSession.CreoJSRootDir).length > 0) {
                        const bomURL = `file:///${pfcSession.CreoJSRootDir}/${bomHTML}`
                        session.NavigatorPaneBrowserAdd ('web_data', 'bom_info16x16.png', bomURL)
                        session.NavigatorPaneBrowserURLSet ('web_data', bomURL)
                    }
                }
                function addStandardParameters (model) {
                    addParameters (model, ...args)
                    addParameters (model, ...currentTimestampParameters('CREATED_BY', 'CREATED_AT'))
                }
                function getAnchorPart () {
                    const anchorFileName = `${anchorPartName}.prt`
                    let anchorPart = session.ListModels ().find (m=>m.FileName === anchorFileName)
                    if (!anchorPart) {
                        try {
                            anchorPart = session.openModelFromSearchPath (anchorFileName)
                        }
                        catch (ex) {
                            if (askQuestion (`Anchor part '${anchorFileName}' is not found. Create it?`)) {
                                const name = session.UIReadStringMessage ();
                                anchorPartName = name || anchorPartName
                                try {
                                    anchorPart = session.CreatePart (anchorPartName)
                                    modelListener.OnAfterModelCreate (anchorPart)
                                    anchorPart.Save()
                                    pfcSession.Apps.demo.Prefs.defaults = {anchorPartName}
                                }
                                catch (ex) {
                                    //print (`Exception ${ex} while creating and saving ${anchorPartName}`)
                                    // reportProblem (`Anchor part '${anchorPart}' is not created`)
                                }
                            }
                        }
                    }
                    return anchorPart
                }
                const modelListener = {
                    OnAfterModelCreate : model => {
                        //print (`model ${model.FileName} created`)
                        addStandardParameters (model)
                        if (model.Type === pfcModelType.MDL_ASSEMBLY) {
                            let anchorPart = getAnchorPart()
                            if (anchorPart) {
                                model.AssembleComponent (anchorPart)
                            }
                            else {
                                session.UIDisplayMessage	("creo_js_messages.txt", "NonLocalizedMessage", [`Creating '${model.FileName}' without anchor part`])	
                            }
                        }
                        updateNavigatorPane ()
                    },
                    OnBeforeParameterCreate : (owner, name, value) => {
                        // workaround for CB expected to always be present
                    }
                }
                CreoJS.addListener (session, pfcModelActionListener.create (modelListener))
                //print (`model listener set: ${modelListener}`)
                const solidListener = {
                    OnAfterFeatureCreate: (solid, feature) => updateNavigatorPane (),
                    OnAfterFeatureDelete: (solid, id) => updateNavigatorPane ()
                }
                CreoJS.addListener (session, pfcSolidActionListener.create (solidListener))
                //print (`solid listener set: ${solidListener}`)
                                
                session.createUICommand ({name: 'add_std_params', label: 'AddStandardParameters', icon: 'parameters_large.png',
                    action: () => addStandardParameters (session.GetActiveModel()),
                    access: arg => {
                        const active = session.GetActiveModel()
                        return active && !active.ListParams().find (p => p.Name === 'CREATED_BY')
                    }})
                session.createUICommand ({name: 'erase_all_models', label: 'EraseAll', icon: 'delete_all_large.png',
                    action: () => {
                        //print (`action for 'erase_all_models'`)
                        try {
                            session.ListWindows().map (w=>w.GetModel()).filter (m=>m).forEach (m=>m.Erase())
                            session.EraseUndisplayedModels()
                            if (session.ListModels().length > 0) {
                                // repeat since some model in windows can prevent hidden dependencies erasure
                                session.runUICommand ('erase_all_models')
                            }
                        }
                        catch (ex) {
                            //print (`Exception ${ex} while cleaning session`)
                        }
                    },
                    access: arg => session.ListModels().length > 0
                })
            }
               
            if (!pfcSession.Storage.customParametersOnCreate) {
                testAddingParameterOnModelCreate (
                    {name: 'CUSTOM_STRING', value: 'KPACOTA'},
                    {name: 'CUSTOM_INTEGER', value: 1997},
                    {name: 'CUSTOM_DOUBLE', value: Math.PI},
                    {name: 'CUSTOM_BOOLEAN', value: true}
                )
                pfcSession.Storage.customParametersOnCreate = true
                Browser.confirmInitialization ('<span style="font-weight:bold;color:green">Application initialized!</span>')
            }
            else {
                Browser.confirmInitialization ('<span style="font-weight:bold;color:orange">Application already initialized</span>')
            }
        }

    </script>

    <script>
        function confirmInitialization (message) {
            document.getElementById ('message').innerHTML = message
        }
    </script>
</head>

<body>
    <span id=message>Initializing...</span>
    <p>After application is initialized execute the following steps</p>
    <ol>
        <li>
            Add application commands to Creo ribbon. Skip this step, if the commands have already been added to the ribbon
            <ul>
                <li>Open <b>Creo Application Options</b> in <b>File->Options</b> menu</li>
                <li>Select <b>Customize->Ribbon</b></li>
                <li>Select Category <b>TOOLKIT Commands</b></li>
                <li>Search for commands <b>Add Standard Parameters</b> and <b>Erase All Models</b></li>
                <li>Add New Group <b>Creo.JS Tests</b> to <b>Common (Global Tab)</b></li>
                <li>Drag and drop the commands into the created group. You should see them in the ribbon now</li>
            </ul>
        </li>
        <li>
            Test application parameters added to model on its creation
            <ul>
                <li>Create a new part</li>
                <li>Open part <b>Parameters</b> dialog</li>
                <li>Check <b>CREATED_AT</b>, <b>CREATED_BY</b>, and some other parameters automatically added on part creation</li>
                <li><b>CREATED_AT</b> captured part creation time in ISO format</li>
                <li><b>CREATED_BY</b> captured user name from USER environment variable</li>
            </ul>
        </li>
        <li>
            Test a default part assembled into a newly created assembly
            <ul>
                <li>Create a new assembly</li>
                <li>If you have anchor.prt in session or in Creo load path it will be added to the assembly</li>
                <li>If anchor.prt is not found you will be asked to enter a name for the default part</li>
                <li>After the name is provided the new part is created and added to the assembly</li>
                <li>The name of the default part is saved and will be reused for another assembly creation</li>
                <li>Try to create another assembly and observe that the default part is added automatically without further question</li>
                <li>Check that the new assemblies and the part all have application parameters added on creation</li>
            </ul>
        </li>
        <li>
            Test UI command adding missing application parameters to active model
            <ul>
                <li>Select any model create in the steps above</li>
                <li>Select <b>Common</b> tab in the ribbon</li>
                <li>Observe that <b>Add Standard Parameters</b> button is grayed out</li>
                <li>Open model <b>Parameters</b> dialog and delete <b>CREATED_BY</b> parameter. Push OK</li>
                <li><b>Add Standard Parameters</b> button got enabled</li>
                <li>Push <b>Add Standard Parameters</b> and it gets disabled again</li>
                <li>Check that deleted parameter got recreated</li>
            </ul>
        </li>
        <li>
            Test navigation tab updated on part feature creation/deletion
            <ul>
                <li>Open part created in the beginning</li>
                <li>Select rightmost tab in navigation panel</li>
                <li>This tab was created by the loaded application</li>
                <li>The tab shows an HTML page with model information: some mass properties and feature list</li>
                <li>It is rendered by Creo.JS application loaded by the page. The application gets the active model data from the session on each refresh</li>
                <li>Create a simple solid feature and observe page refreshed with updated data</li>
                <li>The page is flickering but it can be coded to update only changed data without reload</li>
            </ul>
        </li>
        <li>
            Test Erase All Models command
            <ul>Push <b>Erase All Models</b> button on Common tab</ul>
            <ul>Observe all models deleted from the session</ul>
        </li>
        <li>Note, if you reload this page the application will not be initialized again. This is to prevent duplicate initialization of the commands which is not supported by Creo Toolkit</li>
    </ol>
</body>
</html>