<head>

<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
-->

<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Quicksand" />
<link rel="stylesheet" type="text/css" href="libs/css/pretty-json.css" />

<script type="text/javascript" src="libs/jquery-3.3.1.min.js" ></script>
<script type="text/javascript" src="libs/underscore-min.js" ></script>
<script type="text/javascript" src="libs/backbone-min.js" ></script>
<script type="text/javascript" src="libs/pretty-json-min.js" ></script>

<script type="text/javascript" src="earcut.min.js"></script>
<script type="text/javascript" src="babylon.js"></script>
<script type="text/javascript" src="babylonjs.loaders.min.js"></script>
<script type="text/javascript" src="pep.js"></script>

<link rel="stylesheet" href="creo.ui.min.css">
    
<script src="creojs.js"></script>
<creojs src="browser.creojs"></creojs>

<!-- Web.Link initialization tools -->

<script>

    var pfcCreate;
    var pfcGetCurrentSession;
    var pfcFeatureType;
    var pfcModelItemType;

    {
        (function () {
            pfcCreate = (function () {
                var ua = navigator.userAgent.toString ().toLowerCase ();
                if (ua.indexOf ('chrome/') > -1) {
                    return function (className) {return pfcCefCreate (className)}
                }
                else if (ua.indexOf ('trident') != -1) {
                    return function (className) {return new ActiveXObject ('pfc.' + className)}
                }
                alert ('Unsupported type of embedded browser: ' + ua)
                return function () {return null}
            }) ()
            
            var session = null
            pfcGetCurrentSession = function () {
                if (!session) {
                    var global = pfcCreate ("MpfcCOMGlobal")
                    if (global) {
                        session = global.GetProESession ()
                        pfcFeatureType = pfcCreate ("pfcFeatureType")
                        pfcModelItemType = pfcCreate ("pfcModelItemType")
                        alert ("Successfully connected to Creo !")
                    }
                    else {
                        alert ("Cannot connect to Creo !")
                    }
                }
                return session
            }

            var arrayFrom = Array.from

            Array.from = function (source) {
                if (!source) {
                    return []
                }
                else if (typeof source === 'array') {
                    return source
                }
                else if (('Count' in source) && ('Item' in source)) {
                    var arr = []
                    var count = source.count
                    for (var idx=0; idx<count; idx++) arr.push (source.Item (idx))
                    return arr
                }
                else if (arrayFrom) {
                    return arrayFrom (source)
                }
                else {
                    return [source]
                }
            }
            
            if (!Object.assign) {
                Object.assign = function (target, source) {
                    for (var name in source) target [name] = source [name]
                    return target
                }
            }
        }) ()
    }

    function getFeatureType (feature) {return feature.FeatType}

    alert ('Active model: ' + pfcGetCurrentSession ().GetActiveModel ().FileName)

</script>

<!-- Creo.JS initialization tools -->
<creojs>

    function getFeatureType (feature) {return feature.FeatType.value ()}
    
</creojs>
    
<!-- Application UI -->

<script>

    function clearOutput () {
        ['json', 'messages', 'output', 'elapsedtime'].forEach (function (id) {document.getElementById(id).innerHTML = ''})
    }

    var FILENAME_FORMAT = /.*\.(.*)/

    function modelIcon (filename) {
        var match = FILENAME_FORMAT.exec(filename)
        if (match) {
            switch (match [1].toLowerCase ())
            {
                case 'prt': return 'prt16x16.png'
                case 'asm': return 'asm16x16.png'
            }
        }
        return null
    }

    function featureType (f) {
        switch (f) {
            case 0: return "FEATTYPE_FIRST"
            case 1: return "FEATTYPE_HOLE"
            case 2: return "FEATTYPE_SHAFT"
            case 3: return "FEATTYPE_ROUND"
            case 4: return "FEATTYPE_CHAMFER"
            case 5: return "FEATTYPE_SLOT"
            case 6: return "FEATTYPE_CUT"
            case 7: return "FEATTYPE_PROTRUSION"
            case 8: return "FEATTYPE_NECK"
            case 9: return "FEATTYPE_FLANGE"
            case 10: return "FEATTYPE_RIB"
            case 11: return "FEATTYPE_EAR"
            case 12: return "FEATTYPE_DOME"
            case 13: return "FEATTYPE_DATUM_PLANE"
            case 14: return "FEATTYPE_LOC_PUSH"
            case 15: return "FEATTYPE_UDF"
            case 16: return "FEATTYPE_DATUM_AXIS"
            case 17: return "FEATTYPE_DRAFT"
            case 18: return "FEATTYPE_SHELL"
            case 19: return "FEATTYPE_DOME2"
            case 20: return "FEATTYPE_CORNER_CHAMFER"
            case 21: return "FEATTYPE_DATUM_POINT"
            case 22: return "FEATTYPE_IMPORT"
            case 23: return "FEATTYPE_COSMETIC"
            case 24: return "FEATTYPE_ETCH"
            case 25: return "FEATTYPE_MERGE"
            case 26: return "FEATTYPE_MOLD"
            case 27: return "FEATTYPE_SAW"
            case 28: return "FEATTYPE_TURN"
            case 29: return "FEATTYPE_MILL"
            case 30: return "FEATTYPE_DRILL"
            case 31: return "FEATTYPE_OFFSET"
            case 32: return "FEATTYPE_DATUM_SURFACE"
            case 33: return "FEATTYPE_REPLACE_SURFACE"
            case 34: return "FEATTYPE_GROOVE"
            case 35: return "FEATTYPE_PIPE"
            case 36: return "FEATTYPE_DATUM_QUILT"
            case 37: return "FEATTYPE_ASSEMBLY_CUT"
            case 38: return "FEATTYPE_UDFTHREAD"
            case 39: return "FEATTYPE_CURVE"
            case 40: return "FEATTYPE_SURFACE_MODEL"
            case 41: return "FEATTYPE_WALL"
            case 42: return "FEATTYPE_BEND"
            case 43: return "FEATTYPE_UNBEND"
            case 44: return "FEATTYPE_SHEETMETAL_CUT"
            case 45: return "FEATTYPE_FORM"
            case 46: return "FEATTYPE_THICKEN"
            case 47: return "FEATTYPE_BEND_BACK"
            case 48: return "FEATTYPE_UDFNOTCH"
            case 49: return "FEATTYPE_UDFPUNCH"
            case 50: return "FEATTYPE_INTERNAL_UDF"
            case 51: return "FEATTYPE_SPLIT_SURFACE"
            case 52: return "FEATTYPE_GRAPH"
            case 53: return "FEATTYPE_SMMFGPUNCH"
            case 54: return "FEATTYPE_SMMFGCUT"
            case 55: return "FEATTYPE_FLATTEN"
            case 56: return "FEATTYPE_SET"
            case 57: return "FEATTYPE_VDA"
            case 58: return "FEATTYPE_SMMFGFORM"
            case 59: return "FEATTYPE_SHEETMETAL_PUNCH_POINT"
            case 60: return "FEATTYPE_LIP"
            case 61: return "FEATTYPE_MANUAL_MILL"
            case 62: return "FEATTYPE_MFGGATHER"
            case 63: return "FEATTYPE_MFGTRIM"
            case 64: return "FEATTYPE_MFGUSE_VOLUME"
            case 65: return "FEATTYPE_CABLE_LOCATION"
            case 66: return "FEATTYPE_CABLE_SEGMENT"
            case 67: return "FEATTYPE_CABLE"
            case 68: return "FEATTYPE_COORD_SYS"
            case 69: return "FEATTYPE_CHANNEL"
            case 70: return "FEATTYPE_AREA_NIBBLE"
            case 71: return "FEATTYPE_PATCH"
            case 72: return "FEATTYPE_PLY"
            case 73: return "FEATTYPE_CORE"
            case 74: return "FEATTYPE_EXTRACT"
            case 75: return "FEATTYPE_MFGREFINE"
            case 76: return "FEATTYPE_SILHOUETTE_TRIM"
            case 77: return "FEATTYPE_SPLIT"
            case 78: return "FEATTYPE_EXTEND"
            case 79: return "FEATTYPE_SOLIDIFY"
            case 80: return "FEATTYPE_INTERSECT"
            case 81: return "FEATTYPE_ATTACH"
            case 82: return "FEATTYPE_CROSS_SECTION"
            case 83: return "FEATTYPE_UDFZONE"
            case 84: return "FEATTYPE_UDFCLAMP"
            case 85: return "FEATTYPE_DRILL_GROUP"
            case 86: return "FEATTYPE_ISEGMENT"
            case 87: return "FEATTYPE_CABLE_COSMETIC"
            case 88: return "FEATTYPE_SPOOL"
            case 89: return "FEATTYPE_COMPONENT"
            case 90: return "FEATTYPE_MFGMERGE"
            case 91: return "FEATTYPE_FIXTURE_SETUP"
            case 92: return "FEATTYPE_FLAT_PAT"
            case 93: return "FEATTYPE_CONT_MAP"
            case 94: return "FEATTYPE_EXP_RATIO"
            case 95: return "FEATTYPE_RIP"
            case 96: return "FEATTYPE_OPERATION"
            case 97: return "FEATTYPE_WORKCELL"
            case 98: return "FEATTYPE_CUT_MOTION"
            case 99: return "FEATTYPE_CUSTOMIZE"
            case 100: return "FEATTYPE_DRV_TOOL_SKETCH"
            case 101: return "FEATTYPE_DRV_TOOL_EDGE"
            case 102: return "FEATTYPE_DRV_TOOL_CURVE"
            case 103: return "FEATTYPE_DRV_TOOL_SURF"
            case 104: return "FEATTYPE_MATERIAL_REMOVAL"
            case 105: return "FEATTYPE_TORUS"
            case 106: return "FEATTYPE_PIPE_SET_START"
            case 107: return "FEATTYPE_PIPE_POINT_TO_POINT"
            case 108: return "FEATTYPE_PIPE_EXTEND"
            case 109: return "FEATTYPE_PIPE_TRIM"
            case 110: return "FEATTYPE_PIPE_FOLLOW"
            case 111: return "FEATTYPE_PIPE_JOIN"
            case 112: return "FEATTYPE_AUXILIARY"
            case 113: return "FEATTYPE_PIPE_LINE"
            case 114: return "FEATTYPE_LINE_STOCK"
            case 115: return "FEATTYPE_SOLID_PIPE"
            case 116: return "FEATTYPE_BULK_OBJECT"
            case 117: return "FEATTYPE_SHRINKAGE"
            case 118: return "FEATTYPE_PIPE_JOINT"
            case 119: return "FEATTYPE_PIPE_BRANCH"
            case 120: return "FEATTYPE_DRV_TOOL_TWO_CNTR"
            case 121: return "FEATTYPE_SUB_HARNESS"
            case 122: return "FEATTYPE_SHEETMETAL_OPTIMIZE"
            case 123: return "FEATTYPE_DECLARE"
            case 124: return "FEATTYPE_SHEETMETAL_POPULATE"
            case 125: return "FEATTYPE_OPERATION_COMPONENT"
            case 126: return "FEATTYPE_MEASURE"
            case 127: return "FEATTYPE_DRAFT_LINE"
            case 128: return "FEATTYPE_REMOVE_SURFACES"
            case 129: return "FEATTYPE_RIBBON_CABLE"
            case 130: return "FEATTYPE_ATTACH_VOLUME"
            case 131: return "FEATTYPE_BLD_OPERATION"
            case 132: return "FEATTYPE_UDFWORK_REGION"
            case 133: return "FEATTYPE_SPINAL_BEND"
            case 134: return "FEATTYPE_TWIST"
            case 135: return "FEATTYPE_FREE_FORM"
            case 136: return "FEATTYPE_ZONE"
            case 137: return "FEATTYPE_WELDING_ROD"
            case 138: return "FEATTYPE_WELD_FILLET"
            case 139: return "FEATTYPE_WELD_GROOVE"
            case 140: return "FEATTYPE_WELD_PLUG_SLOT"
            case 141: return "FEATTYPE_WELD_SPOT"
            case 142: return "FEATTYPE_SHEETMETAL_SHEAR"
            case 143: return "FEATTYPE_RIBBON_PATH"
            case 144: return "FEATTYPE_RIBBON_EXTEND"
            case 145: return "FEATTYPE_ASSEMBLY_CUT_COPY"
            case 146: return "FEATTYPE_DEFORM_AREA"
            case 147: return "FEATTYPE_RIBBON_SOLID"
            case 148: return "FEATTYPE_FLAT_RIBBON_SEGMENT"
            case 149: return "FEATTYPE_POSITION_FOLD"
            case 150: return "FEATTYPE_SPRING_BACK"
            case 151: return "FEATTYPE_BEAM_SECTION"
            case 152: return "FEATTYPE_SHRINK_DIM"
            case 153: return "FEATTYPE_THREAD"
            case 154: return "FEATTYPE_SHEETMETAL_CONVERSION"
            case 155: return "FEATTYPE_CMMMEASURE_STEP"
            case 156: return "FEATTYPE_CMMCONSTR"
            case 157: return "FEATTYPE_CMMVERIFY"
            case 158: return "FEATTYPE_CAV_SCAN_SET"
            case 159: return "FEATTYPE_CAV_FIT"
            case 160: return "FEATTYPE_CAV_DEVIATION"
            case 161: return "FEATTYPE_SHEETMETAL_ZONE"
            case 162: return "FEATTYPE_SHEETMETAL_CLAMP"
            case 163: return "FEATTYPE_PROCESS_STEP"
            case 164: return "FEATTYPE_EDGE_BEND"
            case 165: return "FEATTYPE_DRV_TOOL_PROFILE"
            case 166: return "FEATTYPE_EXPLODE_LINE"
            case 167: return "FEATTYPE_GEOM_COPY"
            case 168: return "FEATTYPE_ANALYSIS"
            case 169: return "FEATTYPE_WATER_LINE"
            case 170: return "FEATTYPE_UDFRMDT"
            case 171: return "FEATTYPE_VOL_SPLIT"
            case 172: return "FEATTYPE_WELD_EDGE_PREP"
            case 173: return "FEATTYPE_SMMFGOFFSET"
            case 174: return "FEATTYPE_SMMFGMATERIAL_REMOVE"
            case 175: return "FEATTYPE_SMMFGCOSMETIC"
            case 176: return "FEATTYPE_SMMFGAPPROACH"
            case 177: return "FEATTYPE_SMMFGSLOT"
            case 178: return "FEATTYPE_SMMFGSHAPE"
            case 179: return "FEATTYPE_IPMQUILT"
            case 180: return "FEATTYPE_USER"
            case 181: return "FEATTYPE_GROUP_HEAD"
            case 182: return "FEATTYPE_DRVD"
            case 183: return "FEATTYPE_SMT_CRN_REL"
            case 184: return "FEATTYPE_SLDBEND"
            case 185: return "FEATTYPE_FLATQLT"
            case 186: return "FEATTYPE_DRV_TOOL_TURN"
            case 187: return "FEATTYPE_HULL_PLATE"
            case 188: return "FEATTYPE_HULL_HOLE"
            case 189: return "FEATTYPE_HULL_CUTOUT"
            case 190: return "FEATTYPE_HULL_STIFFENER"
            case 191: return "FEATTYPE_HULL_BEAM"
            case 192: return "FEATTYPE_HULL_ENDCUT"
            case 193: return "FEATTYPE_HULL_WLD_FLANGE"
            case 194: return "FEATTYPE_HULL_COLLAR"
            case 195: return "FEATTYPE_HULL_DRAW"
            case 196: return "FEATTYPE_HULL_BRACKET"
            case 197: return "FEATTYPE_HULL_FOLDED_FLG"
            case 198: return "FEATTYPE_FR_SYS"
            case 199: return "FEATTYPE_HULL_COMPT"
            case 200: return "FEATTYPE_REFERENCE"
            case 201: return "FEATTYPE_SHELL_EXP"
            case 202: return "FEATTYPE_FREEFORM"
            case 203: return "FEATTYPE_KERNEL"
            case 204: return "FEATTYPE_WELD_PROCESS"
            case 205: return "FEATTYPE_HULL_REP_TMP"
            case 206: return "FEATTYPE_INSULATION"
            case 207: return "FEATTYPE_SLD_PIP_INSUL"
            case 208: return "FEATTYPE_SMT_EXTRACT"
            case 209: return "FEATTYPE_ASSY_MERGE"
            case 210: return "FEATTYPE_DS_OPTIMIZE"
            case 211: return "FEATTYPE_COMP_INTERFACE"
            case 212: return "FEATTYPE_OLE"
            case 213: return "FEATTYPE_TERMINATOR"
            case 214: return "FEATTYPE_WELD_NOTCH"
            case 215: return "FEATTYPE_ASSY_WELD_NOTCH"
            case 216: return "FEATTYPE_ROUTE_MANAGER"
            case 217: return "FEATTYPE_HULL_WELD_NOTCH"
            case 218: return "FEATTYPE_SMM_SLIT"
            case 219: return "FEATTYPE_SMM_HOLE"
            case 220: return "FEATTYPE_SMM_NEST"
            case 221: return "FEATTYPE_SMM_GROOVE"
            case 222: return "FEATTYPE_SMM_ETCH"
            case 223: return "FEATTYPE_ROUTE_PATH"
            case 224: return "FEATTYPE_HULL_SPLIT_BOUND"
            case 225: return "FEATTYPE_SUPERQUILT"
            case 226: return "FEATTYPE_MOLD_SLIDER"
            case 227: return "FEATTYPE_HULL_PAD"
            case 228: return "FEATTYPE_ROUTE_SPOOL"
            case 229: return "FEATTYPE_GLOBAL_MODEL"
            case 230: return "FEATTYPE_HULL_MITRE"
            case 231: return "FEATTYPE_HULL_SLOTCUT"
            case 232: return "FEATTYPE_PATTERN"
            case 233: return "FEATTYPE_PATTERN_HEAD"
            case 234: return "FEATTYPE_FLEX_MUTATOR"
            case 235: return "FEATTYPE_ANNOTATION"
            case 236: return "FEATTYPE_GRANITE_REMOVE_SRFS"
            case 237: return "FEATTYPE_GRANITE_TAPER_EXTR"
            case 238: return "FEATTYPE_GRANITE_TOOL_COMP"
            case 239: return "FEATTYPE_STYLE"
            case 240: return "FEATTYPE_GENERAL_MERGE"
            case 241: return "FEATTYPE_DAMPER"
            case 242: return "FEATTYPE_SPRING"
            case 243: return "FEATTYPE_AUTO_ROUND"
            case 244: return "FEATTYPE_DESIGNATED_AREA"
            case 245: return "FEATTYPE_REMOVE_SURFACE"
            case 246: return "FEATTYPE_ARTWORK"
            case 247: return "FEATTYPE_WELD_COMBINE"
            case 248: return "FEATTYPE_CONTACT3D"
            case 249: return "FEATTYPE_RS_GENERATOR"
            case 250: return "FEATTYPE_RS_TRJ_MOVE"
            case 251: return "FEATTYPE_PLASTIC_RIB"
            case 252: return "FEATTYPE_PM_BELT_CURVE"
            case 253: return "FEATTYPE_VPDD"
            case 254: return "FEATTYPE_SUBDIVISION"
            case 255: return "FEATTYPE_FLEXMOVE"
            case 256: return "FEATTYPE_PM_BUSHING_LD"
            case 257: return "FEATTYPE_FLXATTACH"
            case 258: return "FEATTYPE_FLEXSUBST"
            case 259: return "FEATTYPE_MOD_ROUND"
            case 260: return "FEATTYPE_CE_GEOM"
            case 261: return "FEATTYPE_ANALYT_GEOM"
            case 262: return "FEATTYPE_STAMPED_AREA"
            case 263: return "FEATTYPE_FLX_OGF"
            case 264: return "FEATTYPE_CE_COMP"
            case 265: return "FEATTYPE_MFGPTM_MATREM"
            case 266: return "FEATTYPE_SPLIT_SRF_RGN"
            case 267: return "FEATTYPE_DERIVED_MEMBER"
            case 268: return "FEATTYPE_ACCEPT_CRITERIA"
            case 269: return "FEATTYPE_MOLD_SHUTOFF_SRF"
            case 270: return "FEATTYPE_SMT_SKETCH_FORM"
            case 271: return "FEATTYPE_JOIN_WALLS"
            case 272: return "FEATTYPE_FLX_SOLVER"
            case 273: return "FEATTYPE_CE_SKET"
            case 274: return "FEATTYPE_MOLD_SKIRT_EXT_FEAT"
            case 275: return "FEATTYPE_MOLD_SKIRT_FILL_FEAT"
            case 276: return "FEATTYPE_MOD_CHAMFER"
            case 277: return "FEATTYPE_RCG_ROUND"
            case 278: return "FEATTYPE_RCG_CHAMFER"
            case 279: return "FEATTYPE_UNRCG_ROUND"
            case 280: return "FEAT_UNRCG_CHAMFER"
            case 281: return "FEAT_ECAD_CU_AREAS"
            case 282: return "FEAT_CUSTOM"
            case 283: return "FEAT_CUSTOM_GRANITE"
        }
    }

    function featureIcon (featureType) {
        if (featureType) {
            switch (featureType.toLowerCase ())
            {
                case 'datum_plane': return 'datum_plane16x16.png'
                case 'datum_axis': return 'axis16x16.png'
                case 'first': return 'extrude16x16.png'
                case 'protrusion': return 'extrude16x16.png'
                case 'coord_sys': return 'csys16x16.png'
                case 'group_head': return 'group16x16.png'
                case 'hole': return 'hole16x16.png'
                case 'cut': return 'hole16x16.png'
                case 'curve': return 'datum_curve16x16.png'
                case 'shell': return 'feat_shell16x16.png'
                case 'chamfer': return 'feat_chamfer16x16.png'
                case 'round': return 'feat_round16x16.png'
                case 'component': return 'feat_component16.png'
                case 'pattern_head': return 'pattern16x16.png'
            }
        }
        return null
    }

    function printMessage (title, text) {
        var message = document.createElement("span");
        message.innerHTML = '<b>' + title + ':</b> ' + text
        document.getElementById('messages').appendChild (createListItem (message))
    }

    function printElapsedTime (startTime) {
        var timep = document.getElementById('elapsedtime');
        if (timep && startTime) {
          timep.innerHTML = '<b>Elapsed time:</b> ' + (new Date ().getTime () - startTime.getTime ()) / 1000.0 + ' seconds'
        }
    }

    function createListTextItem (text, icon) {
        return createListItem (document.createTextNode(text), icon)
    }

    function createListItem (item, icon) {
        var node = document.createElement("li");
        if (icon) {
            var inode = document.createElement("img");
            inode.src = icon;
            inode.style.paddingRight = '5px'
            node.appendChild(inode);
        }
        node.appendChild(item);
        return node
    }

    function listModels (models, startTime) {
        clearOutput ()
        var div = document.getElementById('output');
        var list = document.createElement("ul");
        models.forEach (function (model) {list.appendChild(createListTextItem (model, modelIcon (model)))})
        div.appendChild(list);
        printElapsedTime (startTime)
        printMessage ('Model count', models.length)
    }

    function showStructure (bom, startTime) {
        function formatNodes (model) {
            var node = createListTextItem (model.filename, modelIcon (model.filename));
            if (model.components && model.components.length > 0) {
                var list = document.createElement("ul");
                model.components.forEach (function (c) {list.appendChild(formatNodes (c))})
                node.appendChild(list)
            }
            if (model.features && model.features.length > 0) {
                var list = document.createElement("ul");
                model.features.forEach (function (f) {
                    var ftype = featureType (f.type).substring (9)
                    list.appendChild(createListTextItem(f.id + ": " + ftype, featureIcon (ftype)))
                })
                node.appendChild(list)
            }
            return node
        }
        clearOutput ()
        var div = document.getElementById('output');
        var list = document.createElement("ul");
        list.appendChild(formatNodes (bom.bom));
        div.appendChild(list);
        printElapsedTime (startTime)
        printMessage ('Component count', bom.nodeCount)
    }

    function showExpandedObject (title, obj, startTime) {
        var msg = {}
        msg [title] = obj
        printResponseObject (msg, startTime).expandAll ();
    }

    function showException (ex, startTime) {
        showExpandedObject ('EXCEPTION', ex, startTime)
    }
 
    function showError (err, startTime) {
        showExpandedObject ('ERROR', err, startTime)
    }

    function printResponseObject (obj, startTime) {
        clearOutput ()
        if (startTime) printElapsedTime (startTime)
        return showJson (obj)
    }

    function alertObject (obj) {
        alert (obj)
    }

    function showJson (obj) {
        var span = document.getElementById('json');
        return new PrettyJSON.view.Node({ 
                el:span, 
                data:obj
            });
    }

    function printAssemblyStructure () {
        var startTime = new Date ();

        // Web.Link style - synchronous
        //printResponseObject (getAssemblyStructure (), startTime)

        // Creo.JS style - asynchronous
        CreoJS.getAssemblyStructure ().subscribe(printResponseObject)
    }

    function displayAssemblyStructure () {
        var startTime = new Date ();

        // Web.Link style - synchronous
        //showStructure (getAssemblyStructure (true), startTime)

        // Creo.JS style - asynchronous
        CreoJS.getAssemblyStructure (true).subscribe(showStructure)
    }

</script>

<!-- Toolkit application -->
<creojs>

    function getAssemblyStructure (withFeatures, componentFilter, modelFilter) {
        var returnTrue = function () {return true}

        withFeatures = withFeatures || false
        componentFilter = componentFilter || returnTrue
        modelFilter = modelFilter || returnTrue

        var session = pfcGetCurrentSession ();
        var model = session.GetActiveModel ();
    
        function getFeatures (model) {
            return model ? Array.from (model.ListItems (pfcModelItemType.ITEM_FEATURE))
                .map (function (f) {return {id: f.Id, name: f.Name , type: getFeatureType (f)}})
                : [];
		}

        function getComponents (model, onlyVisible) {
            onlyVisible = onlyVisible || false
            return Array.from (model.ListFeaturesByType (onlyVisible, pfcFeatureType.FEATTYPE_COMPONENT))
        }
    
        function getAssemblyStructure (model, withFeatures, componentFilter, modelFilter) {
            const components = model ? getComponents (model)
                .filter (componentFilter)
                .map (function (f) {return {component: f, filename: f.ModelDescr.GetFileName ()}})
                .map (function (c) {return Object.assign (c, {model: session.GetModelFromFileName (c.filename)})})
                .filter (function (c) {return !c.model || (modelFilter && modelFilter (c.model))})
                .map (function (c) {return Object.assign (c, {components: getAssemblyStructure (c.model, withFeatures, componentFilter, modelFilter)})})
                : []
            return withFeatures ? components.map (function (c) {return Object.assign (c, {features: getFeatures (c.model)})}) : components
        }
    
        let nodeCount = 0
        function buildBOM (model, withFeatures) {
            function buildStructure (modelname, components, features) {
                nodeCount++
                return {
                    filename: modelname,
                    features: features,
                    components: components.map (function (c) {return buildStructure (c.filename, c.components, c.features)})}
            }
            return buildStructure (model.FileName, getAssemblyStructure (model, withFeatures, componentFilter, modelFilter), withFeatures ? getFeatures (model) : undefined)
        }
        const bom = buildBOM (model, withFeatures)
        return model ? {nodeCount: nodeCount, bom: bom} : undefined
    }

</creojs>

</head>

<body>
    <div style="padding:10px">
        <button class="btn btn-sm btn-warning" onclick="printAssemblyStructure()">Assembly Structure</button>
        <button class="btn btn-sm btn-warning" onclick="displayAssemblyStructure()">Assembly and Features</button>
        <span style="position:relative;float:right;">
            <input type=checkbox id=creojsdebug>Debug
            <button class="btn btn-sm btn-primary" onclick="clearOutput()">Clear</button>
            <button class="btn btn-sm btn-primary" onclick="window.location.reload (true)">Reload</button>
        </span>
    </div>
    <div style="padding-left:10px; padding-right:10px; width:100%; height:90%; position:relative">
        <p id="elapsedtime"><p>
        <span id="json"></span>
        <ul id="messages"></ul>
        <div id="output" style="width:100%; height:100%; position:relative"></div>
    </div>                    
</body>