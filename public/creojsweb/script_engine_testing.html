<html>
<head>
  <title>Creo JS.Link Shell</title>
      
  <link rel="stylesheet" href="libs/codemirror/lib/codemirror.css">
  <link rel="stylesheet" href="libs/codemirror/addon/dialog/dialog.css">
 
  <script src="libs/codemirror/lib/codemirror.js"></script>
  <script src="libs/codemirror/lib/util/formatting.js"></script>
  <script src="libs/codemirror/mode/javascript/javascript.js"></script>
  <script src="libs/codemirror/addon/search/search.js"></script>
  <script src="libs/codemirror/addon/search/searchcursor.js"></script>
  <script src="libs/codemirror/addon/search/match-highlighter.js"></script>
  <script src="libs/codemirror/addon/edit/matchbrackets.js"></script>
  <script src="libs/codemirror/addon/edit/closebrackets.js"></script>
  <script src="libs/codemirror/addon/dialog/dialog.js"></script>

  <link rel="stylesheet" href="creo.ui.min.css">

  <script src="creojs.js"></script>
  <script type="text/creojs" src="browser.creojs"></script>
  <script type="text/creojs" src="weblink.legacy.creojs"></script>

  <script>
    // var helpRelPath = "apps/apiwizard/output/otk_cpp_doc/objecttoolkit_Creo/api";
    // var helpRelPath = "apps/prokernel/Documentation/apiwizard/java";
    // var helpHost = "http://rdweb.ptc.com/ptcsrc/portsrc/spg/system_1/";
    var helpHost = "file://W:/rpsrcp30/spg/system_1/";
    // var helpRelPath = "weblink/weblinkdoc";
    var helpRelPath = "apps/apiwizard/output/pfcweblink/weblink_Creo";
    
    var helpWindow = null;
    function openHelpWindow (helpMsg)
    {
        var base = helpMsg.help_host;
        var openExistingPage = false;
        if (base) {
            openExistingPage = true;
        }
        else {
            base = helpHost + helpRelPath + "/";
        }
        var openNewWin = true;
        try { openNewWin = (helpWindow == null); }
        catch (err) {}
        if (! openNewWin) {
            try { openNewWin = helpWindow.closed; }
            catch (err) { openNewWin = true; }
        }
        var htmlPage = "";
        var searchParams = "";
        if (helpMsg.html_page) {
            htmlPage = base + '/api/' + helpMsg.html_page;
        }
        else if (helpMsg.help_request) {
            searchParams = "search=" + helpMsg.help_request;
            htmlPage = base + '/api/library.html'
        }

        if (openNewWin) {
            var windowFeatures = "location=yes,resizable=yes,scrollbars=yes,status=yes,height=900,width=1100";
            helpWindow = window.open ("", "Help", windowFeatures);
            var helpHtml = 
                '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Frameset//EN" "DTD/xhtml1-frameset.dtd">\n' +
                '<html xmlns="http://www.w3.org/1999/xhtml">\n' +
                '<head>\n' +
                '<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />\n' +
                '<title>PTC Creo GRANITE Java API Wizard</title>\n' +
                '</head>\n' +
                '<frameset cols="22%, *" style="border:1;">\n' +
                '	<frame src="' + base + '/manual0/APIWizObjects.html?' + searchParams + '" name="menu" id="10" scrolling="auto" />\n' +
                '	<frameset rows="96%, *">\n' +
                '		<frame name="main" id="100" scrolling="auto" src="' + htmlPage + '" />\n' +
                '		<frame src="' + base + '/manual0/footbar.html" name="footbar" id="150" scrolling="no" noresize="noresize"/>\n' +
                '	</frameset>\n' +
                '</frameset>\n' +
                '</html>\n';
            helpWindow.document.open ();
            helpWindow.document.write (helpHtml);
            helpWindow.document.close ();
        }
        else {
            helpWindow.document.frames[0].location.href = base + '/manual0/APIWizObjects.html?' + searchParams;
            if (htmlPage) {
                helpWindow.document.frames [1].location.href = htmlPage;
            }
            helpWindow.focus ();
        }
    }
  
    var codeEditor =null;
    function initialize () {
      CreoJS.$ONREFRESH = function (refresh) {
        listScripts (null, (typeof refresh === 'string') ? refresh : null)
      }
      CreoJS.$ONPRINT = printToConsole
      CreoJS.$ONHELP = function (helpMsg) {
        openHelpWindow (helpMsg);
      }
      CreoJS.$ADD_ON_LOAD (function () {
        listScripts ();
        focusToRun ()
      })
      var options = {
        lineNumbers: true,
        mode: "javascript",
        theme: "default",
        height: "auto",
        smartIndent: true,
        tabSize: 2,
        indentWithTabs: true,
        electricChars: true,
        matchBrackets: true,
        autoCloseBrackets: true
      };
      var textarea = document.getElementById ('codeeditor');
      codeEditor = CodeMirror.fromTextArea (textarea, options);
      codeEditor.setSize ('100%', '100%')
      codeEditor.setValue (INIT_SCRIPT.textContent)
      codeEditor.on ("change", onScriptChange)
    }

    function onScriptChange () {
      SAVE_BUTTON.disabled = currentScript && codeEditor.getDoc ().isClean ()
    }

</script>

  <script id="initialization" type="text/creojs">
    function listScripts () {
      return {scripts: getScriptsList (), sep: $ide_lastChar};
    }

    function scriptDirectory () {
      print ("scriptDirectory = " + $ide_scriptDir);
      return {dir: $ide_scriptDir, sep: $ide_lastChar};
    }
    
    function copyExamplesToScriptFolder (dir) {
        if (copyExamples (dir)) {
            let res = listScripts ();
            res.result = true;
            return res;
        }
        return {result: false};
    }

    if (typeof getScriptFolder !== 'function') {var getScriptFolder = getStriptFolder;}
    const $ide_scriptDir = getScriptFolder ();
    const $ide_lastChar = $ide_scriptDir.slice ($ide_scriptDir.length-1, $ide_scriptDir.length);
    // print ("ide_lastChar = " + $ide_lastChar);
    // print ("ide_scriptDir = " + $ide_scriptDir);
  </script>

</head>
<body onmouseup="mouseUp ()" onmousemove="moveMouse()" onload="initialize ()">
    <div style="margin:5px">
        <span style="font-size: 14px; font-family: Arial, Helvetica, sans-serif">Scripts</span>
    <select style="margin-left:5px;border-radius: 4px;font-size: 14px;padding: 2px;" id="scriptlist" onchange="loadScript ();">
     <option>Load Script...</option>
    </select>
    <button class="btn btn-sm btn-success" onclick="newScript ()" title="Create new script" id="newbtn">New</button>
    <!--button class="btn btn-sm btn-success" onclick="loadScript ()" id="loadbtn">Load</button-->
    <button class="btn btn-sm btn-success" id="SAVE_BUTTON" onclick="saveScriptToCreo ()" title="Save current script">Save</button>
    <button class="btn btn-sm btn-success" onclick="saveAsScriptToCreo ()" title="Create script under new name">Save As...</button>
        <button class="btn btn-sm btn-danger" onclick="openHelp ()" title="Open Help Pages"><!--img src="help.gif"/-->Help</button>
    <button class="btn btn-sm btn-info" onclick="listScripts ()" title="Refresh scripts list">Refresh</button>
    <button class="btn btn-sm btn-warning" onclick="CreoJS.$RESET ()" title="Reset script engine">Reset</button>
    <button class="btn btn-sm btn-info" style="position:relative;float:right;margin-right:15px" onclick="window.location.reload (true)" title="Reload the current page">Reload</button>
  </div>
  <div style="height: 50%; border-top-style: solid; border-top-width: thin; border-bottom-style: solid; border-bottom-width: thin;" id='toppanel' class='toppanel'>
    <textarea style="height: 100%; width: 100%" id="codeeditor">print ("Your Creo.JS Script here"); // Click Run to execute this script</textarea>
  </div>
  <div style="margin-top:8px;overflow:auto;">
    <div style="float: left;"><button class="btn btn-sm btn-success" onclick="sendScriptToCreo ()" title="Run current script" id="runbtn">Run</button></div>
    <div style="float: left;"><button class="btn btn-sm btn-success" onclick="clearConsole (); setTimeout (function () {sendScriptToCreo ();});" title="Clear console and run current script">Clear and Run</button></div>
    <div style="float: left;"><button class="btn btn-sm btn-warning" onclick="clearConsole ()" title="Clear console">Clear</button></div>
    <div style="float: left;"><button class="btn btn-sm btn-success" onclick="CreoJS.$RESET (); setTimeout (function () {sendScriptToCreo ();});" title="Reset script engine and run current script">Reset and Run</button></div>
    <div style="overflow:hidden;"><input id="SINGLE_COMMAND" placeholder="Type script and hit 'Enter' to execute. ? - print history" style="margin: 3px 0px 0px 2px; padding-left: 4px; vertical-align: middle; width:100%; height:26px; line-height: 20px; font-family: monospace; font-size: 14px;" type="text" onFocus="selectScriptLine()" onKeyUp="scriptLineKeyEvent(event)"/></div>
  </div>
  <hr onmousedown="mouseDown()" style="cursor:n-resize; border-top: 3px double gray" id=separator>
  <div id="bottompanel" class='bottompanel' style="overflow:auto">
    <table><tr><td>
      <div id="graphics" class='graphics'></div>
    </td><td>
      <pre id="console" class='console'></pre>
    </td></tr></table>
  </div>

  <script>

    var textareaElem = document.getElementById ('codeeditor')
    var movingSeparator = false;
    var upperH;
    var mouseY;

    function mouseDown () {
        movingSeparator = true;
        upperH = toppanel.getBoundingClientRect().height
        mouseY = window.event.clientY
    }

    function mouseUp () {
        movingSeparator = false;
    }

    function moveMouse () {
        var shift = window.event.clientY-mouseY
        if (movingSeparator) {
            if (shift) toppanel.style.height = (upperH + shift) + 'px'
            adjustConsoleHeight ()
        }
    }

    function adjustConsoleHeight () {
      bottompanel.style.height = Math.round (window.innerHeight-separator.getBoundingClientRect().bottom - 17) + 'px'
    }

    window.addEventListener("resize", adjustConsoleHeight);

    var scripts = {}
    var select = document.getElementById ('scriptlist')
    //var loadbtn = document.getElementById ('loadbtn')
    var runbtn = document.getElementById ('runbtn')
    var unnamed = false
    var promptForCopy = true;

    var currentScript = null;

    function fileName (scriptDir, path) {
      const ind = path.indexOf (scriptDir);
      if (ind == 0) {
        return path.slice (scriptDir.length, path.length);
      }
      return path.match (/.*?(([^/\\]+?)(\.\d+)?)$/) [2];
    }
    
    function dirName (path)
    {
        const m = path.match (/(.*)[\/\\]([^/\\]+)$/);
        if (m) {
            return m [1];
        }
        return null;
    }
    
    function fileInfo (path) 
    {
        const m = path.match (/(.*)[\/\\]([^/\\]+)$/);
        if (m) {
            return {dir: m [1], file: m [2]};
        }
        return null;
    }
    
    function fillScriptList (scriptsData, action, current)
    {
        let curDir = null;
        let domElem = select;
        scriptsData.scripts.forEach (function (fname) {
            const fullName = fname;
            const fi = fileInfo (fname);
            if (fi) {
                fname = fi.file;
                if (fi.dir != curDir) {
                    curDir = fi.dir;
                    domElem = document.createElement ('optgroup');
                    domElem.label = curDir;
                    select.appendChild (domElem);
                }
            }
            var option = document.createElement ('option');
            scripts [fullName] = fname;
            option.innerHTML = fname;
            option.value = fullName;
            domElem.appendChild (option);
        });
        if (unnamed) addUnnamed ()
        select.value = currentScript || current
        if (action) {
            action (scriptsData.sep);
        }
    }
    
    function listScripts (action, current) {
        scripts = {}
        current = current || select.value
        select.innerHTML = ''
        unnamed = current == 'UNNAMED'
        CreoJS.listScripts ().subscribe (function (scriptsData) {
            if (scriptsData.scripts.length > 0) {
                fillScriptList (scriptsData, action, current);
            }
            else {
                if (promptForCopy) {
                    const dir = prompt ("Script directory is empty. If you want to copy examples to your script directory please enter the directory or zip file they are contained in below or leave it blank to use default", "");
                    if (dir != null) {
                        CreoJS.copyExamplesToScriptFolder (dir).subscribe (function (scriptsData) {
                            if (scriptsData.result) {
                                fillScriptList (scriptsData, action, current);
                            }
                            else {
                                alert ("Failed to copy");
                            }
                        });
                    }
                    promptForCopy = false;
                }
            }
        });
    }
    
    function focusToLoad () {
      //loadbtn.focus ()
    }
    
    function focusToRun () {
      runbtn.focus ()
    }
    
    select.addEventListener ('change', focusToLoad);
    
    //select.addEventListener ('focus', listScripts);

    function saveScriptToFile (file, afterAction) {
      if (file) {
        currentScript = file
        const script = codeEditor.getValue ()
        setTimeout (function () {
          CreoJS.$SAVE (file, script)
          codeEditor.getDoc ().markClean ()
          onScriptChange ()
          if (afterAction) {
            afterAction ();
          }
        })
      }
    }
    
    function saveScriptToCreo (afterAction) {
      if (select.value) {
        saveScriptToFile (select.value, afterAction);
      }
    }
    
    var jsFullFileName = /([^\/\\]+)\.js$/;
    var jsExt = /\.js$/i;
    var numberedName = /(.*)_(\d+)$/;
    
    function getDefaultNewFileName ()
    {
        let newName = "jslink";
        let fname = document.getElementById ('scriptlist').value;
        if (fname != "") {
            if (jsExt.test (fname)) {
              newName = fname.slice (0, fname.length-3);
              const submatch = numberedName.exec (newName);
                if (submatch) {
                    newName = submatch [1];
                }
            }
        }
        return newName + "_";
    }
    
    var jsFileName = /.+\.js$/;
    
    function saveAsScriptToCreo () {
      listScripts (function (sep) {
        var file = 'x';
        var defname = getDefaultNewFileName ();
        // alert ('saveAsScriptToCreo scripts = ' + JSON.stringify (scripts))
        for (var jsNameCount = 1; (file = defname + jsNameCount + '.js') in scripts; jsNameCount++);
        file = prompt ("Enter file name", file);
        if (file) {
          if (file in scripts) {
            if (!confirm ('File ' + file + ' exists. Overwrite?')) return;
          }
          if (!jsExt.test (file)) {
            file = file + '.js'
          }
          file = file.replace (/[\/\\]+/g, sep)
          saveScriptToFile (file)
        }
      });
    }

      function openHelp() {
          var text;
          if (window.getSelection) {
              text = window.getSelection().toString();
          }
          if (!text) {
              text = codeEditor.getDoc().getSelection()
          }
          executeScript (text ? ('help("' + text + '")') : "help()")
      }

    var console = document.getElementById ('console');

    function clearConsole () {
      console.innerHTML = ''
    }

    function printToConsole (line, style) {
      var span = document.createElement ('span')
      if (style) span.setAttribute("style", style);
      span.innerHTML = line + '\n'
      console.appendChild (span)
      adjustConsoleHeight ()
      span.scrollIntoView()
    }

    function sendScriptToCreo() {
      var script = codeEditor.getValue();
      setTimeout(function () {
          CreoJS.$EXEC(currentScript ? currentScript : 'editor', script, printToConsole)
      })
    }

    var lineStack = [];
    var lineCurrent = -1;

    function lineStackUp() {
      if (lineCurrent < lineStack.length-1) {
        SINGLE_COMMAND.value = lineStack [++lineCurrent]
      }
    }

    function lineStackDown() {
      if (lineCurrent > 0) {
        SINGLE_COMMAND.value = lineStack [--lineCurrent]
      }
    }

    function selectScriptLine () {
      SINGLE_COMMAND.setSelectionRange(0, SINGLE_COMMAND.value.length)
    }

    function scriptLineKeyEvent(event) {
      switch (event.keyCode) {
        case 13: executeSignleLine(SINGLE_COMMAND.value); SINGLE_COMMAND.value=""; break;
        case 38: lineStackDown(); break;
        case 40: lineStackUp(); break;
      }
    }

    function executeSignleLine(script) {
      if (script) {
        script = script.trim()
        if (script === '?') {
          for (var idx=0; idx < lineStack.length; idx++) {
            var line = '[' + idx + '] ' + lineStack [idx]
            printToConsole (line, (idx === (lineCurrent-1)) ? "font-weight:bold;color:green" : "font-weight:bold")
          }
        }
        else {
            printToConsole (script, "font-weight:bold;font-style:italic")
            executeScript (script);
            if ((lineCurrent > -1) && (lineCurrent < lineStack.length) && (script === lineStack [lineCurrent])) {
              lineCurrent++
            }
            else {
              lineStack.push (script);
              if (lineStack.length > 50) {
                lineStack.splice (0, lineStack.length - 50)
              }
              lineCurrent = lineStack.length
            }
        }
      }
    }

    function executeScript(script) {
      script = script || SINGLE_COMMAND.value;
      if (script) {
        setTimeout(function () {
            CreoJS.$EXEC('command', script, printToConsole)
        })
      }
    }
    
    function addUnnamed () {
      var option = document.createElement ('option');
      option.innerHTML = 'UNNAMED';
      option.value = option.innerHTML;
      select.appendChild (option);
      unnamed = true
    }

    function newScript () {
      currentScript = null
      codeEditor.setValue (INIT_SCRIPT.textContent)
      codeEditor.getDoc ().markClean ()
      if (!unnamed) addUnnamed ()
      select.value = 'UNNAMED'
    }
    
    function loadScript () {
      let select = document.getElementById ('scriptlist')
      loadScriptFromCreo (select.value);
    }
    
    function loadScriptFromCreo (filename) {
      function loadThisScript () {
        CreoJS.$LOAD (filename, function (script) {
          currentScript = filename
          codeEditor.setValue (script)
          codeEditor.getDoc ().markClean ()
          select.value = currentScript
          onScriptChange()
          focusToRun ()
        })
      }
      if (filename !== currentScript) {
        if (currentScript && !codeEditor.getDoc ().isClean ()) {
          if (confirm ('Script "' + currentScript + '" is modified. Save it?')) {
            saveScriptToFile (currentScript, loadThisScript)
          }
          else {
            setTimeout (loadThisScript)
          }
        }
        else {
          setTimeout (loadThisScript)
        }
      }
    }

  </script>
<script id="INIT_SCRIPT" type="text/init">{
  // Click Run to execute this script
	const session = pfcGetCurrentSession ();
  print ("Your Creo.JS Script here");
}
</script>
</body>
</html>