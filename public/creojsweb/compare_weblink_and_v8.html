<head>

<title>Compare Web.Link and Creo.JS</title>

<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Quicksand" />
<link rel="stylesheet" type="text/css" href="libs/css/pretty-json.css" />

<script type="text/javascript" src="libs/jquery-3.3.1.min.js" ></script>
<script type="text/javascript" src="libs/underscore-min.js" ></script>
<script type="text/javascript" src="libs/backbone-min.js" ></script>
<script type="text/javascript" src="libs/pretty-json-min.js" ></script>

<link rel="stylesheet" href="creo.ui.min.css">
    
<script src="creojs.js"></script>
<script type="text/creojs" src="browser.creojs"></script>

<style>
    body {font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;}
</style>

<script>

    var FILENAME_FORMAT = /.*\.(.*)/

    function fileNameToIcon (filename) {
        var match = FILENAME_FORMAT.exec(filename)
        if (match) {
            switch (match [1].toLowerCase ())
            {
                case 'prt': return 'part16x16.png'
                case 'asm': return 'assembly16x16.png'
            }
        }
        return null
    }

    function modelIcon (filename) {
        return iconUrl (fileNameToIcon (filename))
    }

    var featureTypesMap = {}

    function initFeatureTypesMap (map) {
        featureTypesMap = map;
    }

    function featureType (f) {
        return featureTypesMap [f] || "FEATTYPE_UNKNOWN"
    }

    var installIconDir = null;

    function initInstallIconDir (dir) {
        installIconDir = dir
    }

    function iconUrl (icon) {
        return (installIconDir && icon) ? (installIconDir + icon) : icon
    }

    function mapFeatureToIcon (featureType) {
        if (featureType) {
            switch (featureType.toLowerCase ())
            {
                case 'datum_plane': return 'dsgnt_plane.png'
                case 'datum_axis': return 'fix_axis16x16.png'
                case 'first': return 'feat_extrude16x16.png'
                case 'protrusion': return 'feat_extrude16x16.png'
                case 'coord_sys': return 'new_csys_red16x16.png'
                case 'group_head': return 'dtl_create_manage_draft_groups16x16.png'
                case 'hole': return 'feat_hole16x16.png'
                case 'cut': return 'feat_hole16x16.png'
                case 'curve': return 'new_curve_red16x16.png'
                case 'shell': return 'feat_shell16x16.png'
                case 'chamfer': return 'feat_chamfer16x16.png'
                case 'round': return 'feat_round16x16.png'
                case 'component': return 'feat_component16.png'
                case 'assembly_cut_copy': return 'hull_cutout.png'
                case 'pattern_head': return 'feat_pattern16x16.png'
            }
        }
        return null
    }

    function featureIcon (featureType) {
        return iconUrl (mapFeatureToIcon (featureType))
    }

    function createListTextItem (text, icon) {
        return createListItem (document.createTextNode(text), icon)
    }

    function createListItem (item, icon) {
        var node = document.createElement("li");
        if (icon) {
            var inode = document.createElement("img");
            inode.src = icon;
            inode.style.paddingRight = '5px'
            node.appendChild(inode);
        }
        node.appendChild(item);
        return node
    }

    function listModels (models, startTime) {
        clearOutput (sideSuffix)
        var div = document.getElementById('output' + sideSuffix);
        var list = document.createElement("ul");
        models.forEach (function (model) {list.appendChild(createListTextItem (model, modelIcon (model)))})
        div.appendChild(list);
        printElapsedTime (startTime)
        printMessage ('Model count', models.length)
    }

    function showStructure (bom, startTime) {
        function formatNodes (model) {
            var node = createListTextItem (model.filename, modelIcon (model.filename));
            if (model.components && model.components.length > 0) {
                var list = document.createElement("ul");
                model.components.forEach (function (c) {list.appendChild(formatNodes (c))})
                node.appendChild(list)
            }
            if (model.features && model.features.length > 0) {
                var list = document.createElement("ul");
                model.features.forEach (function (f) {
                    var ftype = featureType (f.type).substring (9)
                    list.appendChild(createListTextItem(f.id + ": " + ftype, featureIcon (ftype)))
                })
                node.appendChild(list)
            }
            return node
        }
        clearOutput (sideSuffix)
        var div = document.getElementById('output' + sideSuffix);
        var list = document.createElement("ul");
        list.appendChild(formatNodes (bom.bom));
        div.appendChild(list);
        printElapsedTime (startTime)
        printMessage ('Component count', bom.nodeCount)
    }

</script>

<!-- Web.Link initialization tools -->
<script src="weblink_initialization.js"></script>

<!-- Side-by-side comparison tools -->
<script src="compare_weblink_and_creojs.js"></script>

<!-- Creo.JS initialization tools -->
<script type="text/creojs">
    function getFeatureType (feature) {return feature.FeatType.value ()}
</script>

<!-- Web.Link implementation -->
<script>

    function getAssemblyStructureIE (withFeatures, componentFilter, modelFilter) {
        var returnTrue = function () {return true}

        withFeatures = withFeatures || false
        componentFilter = componentFilter || returnTrue
        modelFilter = modelFilter || returnTrue

        var session = pfcGetCurrentSession ();
        var model = session.GetActiveModel ();
    
        function getFeatures (model) {
            return model ? Array.from (model.ListItems (pfcModelItemType.ITEM_FEATURE))
                .map (function (f) {return {id: f.Id, name: f.Name , type: getFeatureType (f)}})
                : [];
		}

        function getComponents (model, onlyVisible) {
            onlyVisible = onlyVisible || false
            return Array.from (model.ListFeaturesByType (onlyVisible, pfcFeatureType.FEATTYPE_COMPONENT))
        }
    
        function getComponentModels (model) {
            return getComponents (model).map (function (f) {return session.GetModelFromDescr (f.ModelDescr)})
        }
    
        function getAssemblyStructure (model, withFeatures, componentFilter, modelFilter) {
            const components = model ? getComponents (model)
                .filter (componentFilter)
                .map (function (f) {return {component: f, filename: f.ModelDescr.GetFileName ()}})
                .map (function (c) {return Object.assign (c, {model: session.GetModelFromFileName (c.filename)})})
                .filter (function (c) {return !c.model || (modelFilter && modelFilter (c.model))})
                .map (function (c) {return Object.assign (c, {components: getAssemblyStructure (c.model, withFeatures, componentFilter, modelFilter)})})
                : []
            return withFeatures ? components.map (function (c) {return Object.assign (c, {features: getFeatures (c.model)})}) : components
        }
    
        let nodeCount = 0
        function buildBOM (model, withFeatures) {
            function buildStructure (modelname, components, features) {
                nodeCount++
                // if (nodeCount%10 === 0) {alert (nodeCount); printMessage (modelname, nodeCount)}
                if (features) {
                    return {
                        filename: modelname,
                        features: features,
                        components: components.map (function (c) {return buildStructure (c.filename, c.components, c.features)})}
                }
                else {
                    return {
                        filename: modelname,
                        components: components.map (function (c) {return buildStructure (c.filename, c.components, c.features)})}
                }
            }
            return buildStructure (model.FileName, getAssemblyStructure (model, withFeatures, componentFilter, modelFilter), withFeatures ? getFeatures (model) : undefined)
        }
        const bom = buildBOM (model, withFeatures)
        return model ? {nodeCount: nodeCount, bom: bom} : undefined
    }

</script>

<!-- Creo.JS implementation -->

<script type="text/creojs" id="asmstruct.js">
    Browser.initFeatureTypesMap (pfcFeatureType.values().reduce ((ftypes, ft) => {ftypes [ft.value ()] = ft.string (); return ftypes}, {}))
    Browser.initInstallIconDir (pfcGetCurrentSession ().GetEnvironmentVariable ('PRO_DIRECTORY') + '/text/resource/')
</script>

<script type="text/creojs" id="asmstruct.js">
    function getAssemblyStructure (withFeatures, componentFilter = f => true, modelFilter = m => true) {
        let session = pfcGetCurrentSession ();
        let model = session.GetActiveModel ();

        if (!model) {
            throw "No active model"
        }
    
        function getFeatures (model) {
            return model ? model.ListItems (pfcModelItemType.ITEM_FEATURE)
                .map (f => {return {id: f.Id, name: f.Name , type: f.FeatType.value()}})
                : [];
		}

        function getComponents (model, onlyVisible = false) {
            return model.ListFeaturesByType (onlyVisible, pfcFeatureType.FEATTYPE_COMPONENT)
        }
    
        function getComponentModels (model) {
            return getComponents (model).map (f => session.GetModelFromDescr (f.ModelDescr))
        }
    
        function getAssemblyStructure (model, withFeatures, componentFilter, modelFilter) {
            const components = model ? getComponents (model)
                .filter (componentFilter)
                .map (f => Object.assign ({component: f, filename: f.ModelDescr.GetFileName (), modeltype: f.ModelDescr.Type.value ()}))
                .map (c => Object.assign (c, {model: session.GetModelFromFileName (c.filename)}))
                .filter (c => !c.model || (modelFilter && modelFilter (c.model)))
                .map (c => Object.assign (c, {components: getAssemblyStructure (c.model, withFeatures, componentFilter, modelFilter)}))
                : []
            return withFeatures ? components.map (c => Object.assign (c, {features: getFeatures (c.model)})) : components
        }
    
        let nodeCount = 0
        function buildBOM (model, withFeatures) {
            function buildStructure (modelname, modeltype, components, features) {
                nodeCount++
                return {
                    filename: modelname,
                    modeltype: modeltype,
                    features: features,
                    components: components.map (c => buildStructure (c.filename, c.modeltype, c.components, c.features))}
            }
            return buildStructure (model.FileName, model.Descr.Type.value (), getAssemblyStructure (model, withFeatures, componentFilter, modelFilter), withFeatures ? getFeatures (model) : undefined)
        }
        const bom = buildBOM (model, withFeatures)
        return model ? {nodeCount, bom} : undefined
    }
        
</script>

<script>
    function getAndRenderAssemblyStructure (isWebLink) {
        var outputMethod = HTML_OUTPUT.checked ? showStructure : printResponseObject
        var withFeatures = ADD_FEATURES.checked
        sideSuffix = isWebLink ? 'weblink' : 'creojs'
        if (isWebLink) {
            var startTime = new Date ()
            outputMethod (getAssemblyStructureIE (withFeatures), startTime)
        }
        else {
            CreoJS.getAssemblyStructure (withFeatures).then (outputMethod)
        }
    }
</script>

</head>

<body onload="initCompareOutputArea (TEST_DIV, TEST_CONTROLS)">
    <div id="TEST_DIV" style="padding-left:10px; padding-right:10px; width:100%; height:90%; position:relative">
        <h4>Query Current Assembly Structure</h4>
        <div id="TEST_CONTROLS">
            <button class="btn btn-sm btn-success" onclick="getAndRenderAssemblyStructure (false)">Creo.JS</button>
            <button class="btn btn-sm btn-danger" onclick="getAndRenderAssemblyStructure (true)">Web.Link</button>
            <input type=checkbox id="ADD_FEATURES">Features
            <input type=checkbox id="HTML_OUTPUT">HTML
        </div>
    </div>                    
</body>